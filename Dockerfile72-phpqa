FROM wbgrs/php:7.2-node

RUN apt-get install -y gnupg2
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
RUN apt-get upgrade -y --fix-missing || echo "There was some warnings while running apt upgrade"
RUN apt-get update || echo "There was some warnings while running apt update"
RUN apt-get install mariadb-client -y
RUN apt-get install jq libxml2-utils -yqq
RUN apt-get clean
RUN npm install -g diff2html-cli

RUN curl https://gitlab.com/webgears-gmbh/phpqa/-/archive/master/phpqa-master.zip --output phpqa.zip
RUN unzip phpqa.zip
RUN mv phpqa-master /phpqa
RUN rm phpqa.zip

WORKDIR /phpqa
RUN composer install
RUN ln -sr ./scripts/phpunit-coverage vendor/bin/phpunit-coverage
RUN ln -sr ./scripts/phpunit-result vendor/bin/phpunit-result
RUN patch vendor/consolidation/robo/src/Task/Base/ParallelExec.php < error_output.patch

CMD /phpqa/vendor/bin/phpqa
